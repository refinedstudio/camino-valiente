---
import Layout from "../layouts/Layout.astro";
import {
  HeroSection,
  DestinationSection,
  PrimaryCarouselSection,
  ParallaxSection,
  SecondaryCarouselSection,
  TeaserSection,
  DiscoverySection,
} from "../components/pages/home";

import { meta } from "../config";
import type { Content } from "../types";
import { Footer, ConfigurationError } from "../components/shared";
import { obtenerYValidarDatos } from "../utils/api";

// Función auxiliar para extraer texto del contenido
const extraerTexto = (content: any): string => {
  if (typeof content === "string") {
    return content;
  }
  if (content?.root?.children?.[0]?.children?.[0]?.text) {
    return content.root.children[0].children[0].text;
  }
  return "";
};

const { data, isValid: datosValidos } = await obtenerYValidarDatos();
---

{
  datosValidos ? (
    <Layout
      title={meta.home.title}
      description={meta.home.description}
      keywords={meta.home.keywords}
      canonical={meta.home.canonical}
      image={meta.home.image}
      type={meta.home.type}
      robots={meta.home.robots}
    >
      <HeroSection
        image={
          data?.inicio?.inicio?.[0]?.articulo?.[0]?.post?.imagenes?.[0]?.imagen
            ?.url || ""
        }
        titlePage={
          data?.inicio?.inicio?.[0]?.articulo?.[0]?.post?.title ||
          "Contenido cargando..."
        }
        subtitleArticle={
          data?.inicio?.inicio?.[0]?.articulo?.[0]?.post?.subtitle ||
          "Este contenido aún se está cargando"
        }
        facebook={data?.acerca?.social?.facebook || ""}
        youtube={data?.acerca?.social?.youtube || ""}
        tiktok={data?.acerca?.social?.tiktok || ""}
        twitter={data?.acerca?.social?.twitter || ""}
        id={data?.inicio?.inicio?.[0]?.articulo?.[0]?.post?.id || ""}
      />

      {data?.inicio.contenido.map((item: Content, idx: number) => (
        <div>
          {item.blockType === "detailSideMediaBlock" && (
            <DestinationSection
              destinations={[
                {
                  id: item?.articulo[0].post.id,
                  location: item.articulo[0].post.category.title,
                  subtitle: item.articulo[0].post.subtitle,
                  title: item.articulo[0].post.title,
                  description: extraerTexto(item?.articulo?.[0]?.post?.content)
                    ? extraerTexto(item.articulo[0].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                  imageUrl: item.articulo[0].post.imagenes[0].imagen.url,
                  imageAlt: item.articulo[0].post.imagenes[0].imagen.filename,
                  isReversed: false,
                  images: item.articulo[0].post.imagenes.map((image: any) => ({
                    url: image.imagen.url,
                    alt: image.imagen.filename,
                  })),
                },
                {
                  id: item?.articulo[1].post.id,
                  location: item.articulo[1].post.category.title,
                  subtitle: item.articulo[1].post.subtitle,
                  title: item.articulo[1].post.title,
                  description: extraerTexto(item?.articulo?.[1]?.post?.content)
                    ? extraerTexto(item.articulo[1].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                  imageUrl: item.articulo[1].post.imagenes[0].imagen.url,
                  imageAlt: item.articulo[1].post.imagenes[0].imagen.filename,
                  isReversed: true,
                  images: item.articulo[1].post.imagenes.map((image: any) => ({
                    url: image.imagen.url,
                    alt: image.imagen.filename,
                  })),
                },
              ]}
            />
          )}
          {item.blockType === "bannerBlock" && (
            <ParallaxSection
              id={item?.articulo[0].post.id}
              imageUrl={item.articulo[0].post.imagenes[0].imagen.url}
              subtitle={item?.articulo[0].post.subtitle}
              category={item?.articulo[0].post.category.title}
              title={item?.articulo[0].post.title}
            />
          )}
          {item.blockType === "exploreBlock" && (
            <DiscoverySection
              items={[
                {
                  id: item.articulo[0].post.id,
                  imageUrl: item.articulo[0].post.imagenes[0].imagen.url,
                  title: item.articulo[0].post.title,
                  category: item.articulo[0].post.category.title,
                  subtitle: item.articulo[0].post.subtitle,
                },
                {
                  id: item.articulo[1].post.id,
                  imageUrl: item.articulo[1].post.imagenes[0].imagen.url,
                  title: item.articulo[1].post.title,
                  category: item.articulo[1].post.category.title,
                  subtitle: item.articulo[1].post.subtitle,
                },
                {
                  id: item.articulo[2].post.id,
                  imageUrl: item.articulo[2].post.imagenes[0].imagen.url,
                  title: item.articulo[2].post.title,
                  category: item.articulo[2].post.category.title,
                  subtitle: item.articulo[2].post.subtitle,
                },

                {
                  id: item.articulo[3].post.id,
                  imageUrl: item.articulo[3].post.imagenes[0].imagen.url,
                  title: item.articulo[3].post.title,
                  category: item.articulo[3].post.category.title,
                  subtitle: item.articulo[3].post.subtitle,
                },
                {
                  id: item.articulo[4].post.id,
                  imageUrl: item.articulo[4].post.imagenes[0].imagen.url,
                  title: item.articulo[4].post.title,
                  category: item.articulo[4].post.category.title,
                  subtitle: item.articulo[4].post.subtitle,
                },
                {
                  id: item.articulo[5].post.id,
                  imageUrl: item.articulo[5].post.imagenes[0].imagen.url,
                  title: item.articulo[5].post.title,
                  category: item.articulo[5].post.category.title,
                  subtitle: item.articulo[5].post.subtitle,
                },
              ]}
            />
          )}
          {item.blockType === "carouselThreeColumns" && (
            <PrimaryCarouselSection
              slides={[
                {
                  id: item.articulo[0].post.id,
                  imageUrl: item.articulo[0].post.imagenes[0].imagen.url,
                  title: item.articulo[0].post.title,
                  subtitle: item.articulo[0].post.subtitle,
                },
                {
                  id: item.articulo[1].post.id,
                  imageUrl: item.articulo[1].post.imagenes[0].imagen.url,
                  title: item.articulo[1].post.title,
                  subtitle: item.articulo[1].post.subtitle,
                },
                {
                  id: item.articulo[2].post.id,
                  imageUrl: item.articulo[2].post.imagenes[0].imagen.url,
                  title: item.articulo[2].post.title,
                  subtitle: item.articulo[2].post.subtitle,
                },
                {
                  id: item.articulo[3].post.id,
                  imageUrl: item.articulo[3].post.imagenes[0].imagen.url,
                  title: item.articulo[3].post.title,
                  subtitle: item.articulo[3].post.subtitle,
                },
                {
                  id: item.articulo[4].post.id,
                  imageUrl: item.articulo[4].post.imagenes[0].imagen.url,
                  title: item.articulo[4].post.title,
                  subtitle: item.articulo[4].post.subtitle,
                },
                {
                  id: item.articulo[5].post.id,
                  imageUrl: item.articulo[5].post.imagenes[0].imagen.url,
                  title: item.articulo[5].post.title,
                  subtitle: item.articulo[5].post.subtitle,
                },
              ]}
              client:load
            />
          )}
          {item.blockType === "carouselTwoColumns" && (
            <SecondaryCarouselSection
              title="Destacados"
              cards={[
                {
                  id: item.articulo[0].post.id,
                  imageUrl: item.articulo[0].post.imagenes[0].imagen.url,
                  title: item.articulo[0].post.title,
                  subtitle: item.articulo[0].post.subtitle,
                  description: extraerTexto(item?.articulo?.[0]?.post?.content)
                    ? extraerTexto(item.articulo[0].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                },
                {
                  id: item.articulo[1].post.id,
                  imageUrl: item.articulo[1].post.imagenes[0].imagen.url,
                  title: item.articulo[1].post.title,
                  subtitle: item.articulo[1].post.subtitle,
                  description: extraerTexto(item?.articulo?.[1]?.post?.content)
                    ? extraerTexto(item.articulo[1].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                },
                {
                  id: item.articulo[2].post.id,
                  imageUrl: item.articulo[2].post.imagenes[0].imagen.url,
                  title: item.articulo[2].post.title,
                  subtitle: item.articulo[2].post.subtitle,
                  description: extraerTexto(item?.articulo?.[2]?.post?.content)
                    ? extraerTexto(item.articulo[2].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                },
                {
                  id: item.articulo[3].post.id,
                  imageUrl: item.articulo[3].post.imagenes[0].imagen.url,
                  title: item.articulo[3].post.title,
                  subtitle: item.articulo[3].post.subtitle,
                  description: extraerTexto(item?.articulo?.[3]?.post?.content)
                    ? extraerTexto(item.articulo[3].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                },
                {
                  description: extraerTexto(item?.articulo?.[4]?.post?.content)
                    ? extraerTexto(item.articulo[4].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                  id: item.articulo[4].post.id,
                  imageUrl: item.articulo[4].post.imagenes[0].imagen.url,
                  title: item.articulo[4].post.title,
                  subtitle: item.articulo[4].post.subtitle,
                },
                {
                  id: item.articulo[5].post.id,
                  imageUrl: item.articulo[5].post.imagenes[0].imagen.url,
                  title: item.articulo[5].post.title,
                  subtitle: item.articulo[5].post.subtitle,
                  description: extraerTexto(item?.articulo?.[5]?.post?.content)
                    ? extraerTexto(item.articulo[5].post.content).slice(
                        0,
                        300
                      ) + "..."
                    : "Este contenido aún se está cargando...",
                },
              ]}
              client:load
            />
          )}
          {item.blockType === "TwoColumns" && (
            <TeaserSection
              cards={[
                {
                  id: item.articulo[0].post.id,
                  category: item.articulo[0].post.category.title,
                  title: item.articulo[0].post.title,
                  subtitle: item.articulo[0].post.subtitle,
                  imageUrl: item.articulo[0].post.imagenes[0].imagen.url,
                  altText: item.articulo[0].post.imagenes[0].imagen.filename,
                },
                {
                  id: item.articulo[1].post.id,
                  category: item.articulo[1].post.category.title,
                  title: item.articulo[1].post.title,
                  subtitle: item.articulo[1].post.subtitle,
                  imageUrl: item.articulo[1].post.imagenes[0].imagen.url,
                  altText: item.articulo[1].post.imagenes[0].imagen.filename,
                },
              ]}
            />
          )}
        </div>
      ))}

      <Footer
        content={
          data?.inicio?.cierre?.[0]?.articulo
            ? [
                {
                  id: data.inicio.cierre[0].articulo[0]?.post?.id || "",
                  title:
                    data.inicio.cierre[0].articulo[0]?.post?.title ||
                    "Contenido cargando...",
                  imageUrl:
                    data.inicio.cierre[0].articulo[0]?.post?.imagenes?.[0]
                      ?.imagen?.url || "",
                },
                {
                  id: data.inicio.cierre[0].articulo[1]?.post?.id || "",
                  title:
                    data.inicio.cierre[0].articulo[1]?.post?.title ||
                    "Contenido cargando...",
                  imageUrl:
                    data.inicio.cierre[0].articulo[1]?.post?.imagenes?.[0]
                      ?.imagen?.url || "",
                },
                {
                  id: data.inicio.cierre[0].articulo[2]?.post?.id || "",
                  title:
                    data.inicio.cierre[0].articulo[2]?.post?.title ||
                    "Contenido cargando...",
                  imageUrl:
                    data.inicio.cierre[0].articulo[2]?.post?.imagenes?.[0]
                      ?.imagen?.url || "",
                },
                {
                  id: data.inicio.cierre[0].articulo[3]?.post?.id || "",
                  title:
                    data.inicio.cierre[0].articulo[3]?.post?.title ||
                    "Contenido cargando...",
                  imageUrl:
                    data.inicio.cierre[0].articulo[3]?.post?.imagenes?.[0]
                      ?.imagen?.url || "",
                },
                {
                  id: data.inicio.cierre[0].articulo[4]?.post?.id || "",
                  title:
                    data.inicio.cierre[0].articulo[4]?.post?.title ||
                    "Contenido cargando...",
                  imageUrl:
                    data.inicio.cierre[0].articulo[4]?.post?.imagenes?.[0]
                      ?.imagen?.url || "",
                },
                {
                  id: data.inicio.cierre[0].articulo[5]?.post?.id || "",
                  title:
                    data.inicio.cierre[0].articulo[5]?.post?.title ||
                    "Contenido cargando...",
                  imageUrl:
                    data.inicio.cierre[0].articulo[5]?.post?.imagenes?.[0]
                      ?.imagen?.url || "",
                },
              ]
            : [
                {
                  id: "",
                  title: "Este contenido aún se está cargando",
                  imageUrl: "",
                },
              ]
        }
      />
    </Layout>
  ) : (
    <ConfigurationError />
  )
}
